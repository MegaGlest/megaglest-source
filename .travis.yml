# https://docs.travis-ci.com/user/customizing-the-build/
language: cpp
cache: ccache
matrix:
  include:
    - os: linux
      dist: xenial
      compiler: gcc
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
          packages:
            - g++-4.7
      env: MATRIX_EVAL="CC=gcc-4.7 && CXX=g++-4.7"
# use xenial for new versions of gcc and because libsdl2-dev isn't available
# on trusty
    - os: linux
      dist: xenial
      compiler: gcc
      env: MATRIX_EVAL="CC=gcc-5 && CXX=g++-5"
    - os: linux
      dist: xenial
      compiler: gcc
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
          packages:
            - g++-6
      env: MATRIX_EVAL="CC=gcc-6 && CXX=g++-6"
    - os: linux
      dist: xenial
      compiler: gcc
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
          packages:
            - g++-7
      env: MATRIX_EVAL="CC=gcc-7 && CXX=g++-7"
    - os: linux
      dist: xenial
      compiler: gcc
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
          packages:
            - g++-8
      env: MATRIX_EVAL="CC=gcc-8 && CXX=g++-8"
# clang
    - os: linux
      dist: xenial
      compiler: clang
      addons:
        apt:
          sources:
            - llvm-toolchain-xenial-5.0
          packages:
            - clang-5.0
      env: MATRIX_EVAL="CC=clang-5.0 && CXX=clang++-5.0"
# osx
    - os: osx
      osx_image: xcode9.4
      env: XCODE="true"
    - os: osx
      osx_image: xcode10.1
      env: XCODE="true"
  
  fast_finish: true
  allow_failures:
    - os: osx

git:
  submodules: false

before_install:
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then
      eval "${MATRIX_EVAL}";
      sudo apt-get update -qq &&
      sudo $TRAVIS_BUILD_DIR/mk/linux/setupBuildDeps.sh --quiet;
    else
      brew update &&
      brew install sdl2 lua freetype ftgl libogg glew libvorbis cppunit glib fribidi miniupnpc wxmac &&
      brew outdated cmake || brew upgrade cmake; brew outdated pkgconfig || brew upgrade pkgconfig &&
      brew link --force gettext;
    fi
  - echo $CC
  - echo $CXX
  - cmake --version

script:
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then
      if [ "$TRAVIS_COMPILER" = "gcc" ]; then
        mk/linux/build-mg.sh -c 4;
      else
        mk/linux/build-mg.sh -w -c 4;
      fi;
    else
      mk/macos/build-mg.sh -c 4;
    fi

# https://docs.travis-ci.com/user/notifications/#IRC-notification
notifications:
  irc:
    channels:
      - "irc.freenode.org#megaglest"
      - "irc.freenode.org#megaglest-overflow"
      - "irc.freenode.org#megaglest-de"
    skip_join: true
    use_notice: true
    on_success: change
    template:
      - "[%{repository_name}#%{branch}@%{commit}] %{author}: %{message} %{build_url}"

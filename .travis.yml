# https://docs.travis-ci.com/user/customizing-the-build/
language: cpp
cache: ccache
matrix:
  include:
    - os: linux
      dist: trusty
      compiler: gcc
      env: MATRIX_EVAL="CC=gcc-4.8 && CXX=g++-4.8"
# use xenial for new versions of gcc and because libsdl2-dev isn't available
# on trusty
    - os: linux
      dist: xenial
      compiler: gcc
      env: MATRIX_EVAL="CC=gcc-5 && CXX=g++-5"
    - os: linux
      dist: xenial
      compiler: gcc
      env: MATRIX_EVAL="CC=gcc-5 && CXX=g++-5" FORCE_EMBEDDED="-e"
    - os: linux
      dist: xenial
      compiler: gcc
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
          packages:
            - g++-6
      env: MATRIX_EVAL="CC=gcc-6 && CXX=g++-6"
    - os: linux
      dist: xenial
      compiler: gcc
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
          packages:
            - g++-7
      env: MATRIX_EVAL="CC=gcc-7 && CXX=g++-7"
    - os: linux
      dist: xenial
      compiler: gcc
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
          packages:
            - g++-8
      env: MATRIX_EVAL="CC=gcc-8 && CXX=g++-8"
# clang
    - os: linux
      dist: xenial
      compiler: clang
      addons:
        apt:
          sources:
            - llvm-toolchain-xenial-5.0
          packages:
            - clang-5.0
      env: MATRIX_EVAL="CC=clang-5.0 && CXX=clang++-5.0" WITHOUT_WXWIDGETS="-w"
# osx
    - os: osx
      osx_image: xcode9.4
      env: XCODE="true"
    - os: osx
      osx_image: xcode10.1
      env: XCODE="true"
  
  fast_finish: true
  allow_failures:
    - os: osx

git:
  submodules: false

install:
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then
      eval "${MATRIX_EVAL}";
      sudo apt-get update -qq &&
      sudo $TRAVIS_BUILD_DIR/mk/linux/setupBuildDeps.sh --quiet;
      if [ "$TRAVIS_DIST" = "trusty" ]; then
        SDL2_version="2.0.5";
        wget https://www.libsdl.org/release/SDL2-${SDL2_version}.tar.gz &&
        tar xf SDL2-${SDL2_version}.tar.gz                              &&
        cd SDL2-${SDL2_version}                                         &&
        ./configure --enable-static --disable-shared                    &&
        make                                                            &&
        sudo make install;
        cd $TRAVIS_BUILD_DIR;
      fi;
    else
      brew update &&
      brew install sdl2 lua freetype ftgl libogg glew libvorbis cppunit glib fribidi miniupnpc wxmac &&
      brew outdated cmake || brew upgrade cmake; brew outdated pkgconfig || brew upgrade pkgconfig &&
      brew link --force gettext;
    fi

before_script:
  - $CC --version
  - $CXX --version
  - cmake --version
  - BUILD_OPTIONS="-c 4 $FORCE_EMBEDDED $WITHOUT_WXWIDGETS"

script:
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then
      mk/linux/build-mg.sh $BUILD_OPTIONS;
    else
      mk/macos/build-mg.sh $BUILD_OPTIONS;
    fi

# https://docs.travis-ci.com/user/notifications/#IRC-notification
notifications:
  irc:
    channels:
      - "irc.freenode.org#megaglest"
    skip_join: true
    use_notice: true
    on_success: change
    template:
      - "[%{repository_name}#%{branch}@%{commit}] %{author}: %{message} %{build_url}"

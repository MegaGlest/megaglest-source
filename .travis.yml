# https://docs.travis-ci.com/user/customizing-the-build/
language: cpp
matrix:
  include:
    - os: linux
      dist: xenial
      # Default gcc version is 5 on xenial
      compiler: gcc
      env: MATRIX_EVAL="CC=gcc-5 && CXX=g++-5"
    - os: linux
      dist: xenial
      compiler: gcc
      env: MATRIX_EVAL="CC=gcc-5 && CXX=g++-5" FORCE_EMBEDDED="-e"
    - os: linux
      dist: xenial
      compiler: gcc
      env: MATRIX_EVAL="CC=gcc-6 && CXX=g++-6"
    - os: linux
      dist: bionic
      # Default gcc version is 7 on bionic
      compiler: gcc
      env: MATRIX_EVAL="CC=gcc-7 && CXX=g++-7"
    - os: linux
      dist: xenial
      compiler: gcc
      env: MATRIX_EVAL="CC=gcc-8 && CXX=g++-8"
    - os: linux
      dist: bionic
      compiler: gcc
      env: MATRIX_EVAL="CC=gcc-9 && CXX=g++-9"
    - os: linux
      dist: bionic
      compiler: gcc
      env: MATRIX_EVAL="CC=gcc-10 && CXX=g++-10"
# clang
    - os: linux
      dist: xenial
      compiler: clang
      addons:
        apt:
          sources:
            - llvm-toolchain-xenial-5.0
          packages:
            - clang-5.0
      env: MATRIX_EVAL="CC=clang-5.0 && CXX=clang++-5.0" WITHOUT_WXWIDGETS="-w"
# osx
    - os: osx
      osx_image: xcode9.4
      env: XCODE="true"
    - os: osx
      osx_image: xcode10.1
      env: XCODE="true"

  fast_finish: true
  allow_failures:
    - os: osx

git:
  submodules: false

install:
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then
      eval "${MATRIX_EVAL}";
      if [ "$CXX" != "g++-5" ] && [ "$CXX" != "g++-7" ]; then
        sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 6B05F25D762E3157 &&
        sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test;
      fi;
      sudo apt-get update -qq;
      if [ "$CXX" != "g++-5" ] && [ "$CXX" != "g++-7" ]; then
        sudo apt-get install -y $CXX;
      fi;
      sudo $TRAVIS_BUILD_DIR/mk/linux/setupBuildDeps.sh --quiet;
    else
      brew update &&
      brew install sdl2 lua freetype ftgl libogg glew libvorbis cppunit glib fribidi miniupnpc wxmac &&
      brew outdated cmake || brew upgrade cmake; brew outdated pkgconfig || brew upgrade pkgconfig &&
      brew link --force gettext;
    fi

before_script:
  - $CC --version
  - $CXX --version
  - cmake --version
  - BUILD_OPTIONS="-c 4 $FORCE_EMBEDDED $WITHOUT_WXWIDGETS"

script:
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then
      mk/linux/build-mg.sh $BUILD_OPTIONS;
    else
      mk/macos/build-mg.sh $BUILD_OPTIONS;
    fi

# https://docs.travis-ci.com/user/notifications/#IRC-notification
notifications:
  irc:
    channels:
      - "irc.freenode.org#megaglest"
    skip_join: true
    use_notice: true
    on_success: change
    template:
      - "[%{repository_name}#%{branch}@%{commit}] %{author}: %{message} %{build_url}"

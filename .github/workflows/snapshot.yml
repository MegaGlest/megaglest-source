name: Make Snapshot
concurrency:
  group: snapshot-${{ github.ref }}
  cancel-in-progress: true
on:
  workflow_run:
    workflows: [CMake]
    types: [completed]
    branches: [develop]

# The artifact only runs on the same distro that it was built on.
# TODO: make AppImage instead
jobs:
  make-snapshot:
    strategy:
      fail-fast: false
    runs-on: ubuntu-22.04
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
    - uses: actions/checkout@v3
    - name: Get dependencies
      run: |
        echo 'APT::Get::Always-Include-Phased-Updates "false";' | sudo tee /etc/apt/apt.conf.d/99-phased-updates
        sudo apt-get update && sudo apt-get upgrade
        sudo mk/linux/setupBuildDeps.sh
        sudo apt install libfuse2
    - name: Build
      run:  |
        mk/linux/build-appimage.sh
    - name: Create MegaGlest Snapshot
      uses: actions/upload-artifact@v3
      with:
        name: megaglest-x64-ubuntu
        path: |
          mk/linux/MegaGlest*.AppImage
  on-failure:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    steps:
    - run: |
        echo 'The triggering workflow failed'
        exit 1
